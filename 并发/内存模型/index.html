<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>内存模型 | GOFamily - go 后端程序员宝典</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="shortcut icon" type="image/x-icon" href="/GOFamily/favicon.ico">
    <meta name="description" content="🔥 go 后端程序员宝典，包含了：算法，数据库，网络操作系统，分布式，系统设计等一揽子知识体系">
    
    <link rel="preload" href="/GOFamily/assets/css/0.styles.accc8640.css" as="style"><link rel="preload" href="/GOFamily/assets/js/app.a103b542.js" as="script"><link rel="preload" href="/GOFamily/assets/js/2.ed67c6f0.js" as="script"><link rel="preload" href="/GOFamily/assets/js/69.633fc06b.js" as="script"><link rel="prefetch" href="/GOFamily/assets/js/10.733360c3.js"><link rel="prefetch" href="/GOFamily/assets/js/11.82a11e90.js"><link rel="prefetch" href="/GOFamily/assets/js/12.db289772.js"><link rel="prefetch" href="/GOFamily/assets/js/13.71e10a95.js"><link rel="prefetch" href="/GOFamily/assets/js/14.0e813a56.js"><link rel="prefetch" href="/GOFamily/assets/js/15.8187edee.js"><link rel="prefetch" href="/GOFamily/assets/js/16.0c82cc4c.js"><link rel="prefetch" href="/GOFamily/assets/js/17.bcc1b696.js"><link rel="prefetch" href="/GOFamily/assets/js/18.bb028d9e.js"><link rel="prefetch" href="/GOFamily/assets/js/19.243cc602.js"><link rel="prefetch" href="/GOFamily/assets/js/20.ba7f1c47.js"><link rel="prefetch" href="/GOFamily/assets/js/21.7b941cc5.js"><link rel="prefetch" href="/GOFamily/assets/js/22.53470164.js"><link rel="prefetch" href="/GOFamily/assets/js/23.bcb1fdb9.js"><link rel="prefetch" href="/GOFamily/assets/js/24.cf874078.js"><link rel="prefetch" href="/GOFamily/assets/js/25.f51ec545.js"><link rel="prefetch" href="/GOFamily/assets/js/26.5bf01055.js"><link rel="prefetch" href="/GOFamily/assets/js/27.19efeb8c.js"><link rel="prefetch" href="/GOFamily/assets/js/28.aa307a63.js"><link rel="prefetch" href="/GOFamily/assets/js/29.63f2e535.js"><link rel="prefetch" href="/GOFamily/assets/js/3.66193a6c.js"><link rel="prefetch" href="/GOFamily/assets/js/30.0fe35f9f.js"><link rel="prefetch" href="/GOFamily/assets/js/31.655cb41c.js"><link rel="prefetch" href="/GOFamily/assets/js/32.1043fe58.js"><link rel="prefetch" href="/GOFamily/assets/js/33.8f3dc184.js"><link rel="prefetch" href="/GOFamily/assets/js/34.4ef0126c.js"><link rel="prefetch" href="/GOFamily/assets/js/35.8b279a49.js"><link rel="prefetch" href="/GOFamily/assets/js/36.14571c52.js"><link rel="prefetch" href="/GOFamily/assets/js/37.1462b7f9.js"><link rel="prefetch" href="/GOFamily/assets/js/38.3be82514.js"><link rel="prefetch" href="/GOFamily/assets/js/39.9324f88a.js"><link rel="prefetch" href="/GOFamily/assets/js/4.1ec5e302.js"><link rel="prefetch" href="/GOFamily/assets/js/40.177e0c87.js"><link rel="prefetch" href="/GOFamily/assets/js/41.2f4b9348.js"><link rel="prefetch" href="/GOFamily/assets/js/42.e7f846a2.js"><link rel="prefetch" href="/GOFamily/assets/js/43.ca618db2.js"><link rel="prefetch" href="/GOFamily/assets/js/44.270530dc.js"><link rel="prefetch" href="/GOFamily/assets/js/45.d5b29b3f.js"><link rel="prefetch" href="/GOFamily/assets/js/46.475ad7f5.js"><link rel="prefetch" href="/GOFamily/assets/js/47.29f45526.js"><link rel="prefetch" href="/GOFamily/assets/js/48.89a95db2.js"><link rel="prefetch" href="/GOFamily/assets/js/49.99bf2079.js"><link rel="prefetch" href="/GOFamily/assets/js/5.b3141e55.js"><link rel="prefetch" href="/GOFamily/assets/js/50.13aa7ef6.js"><link rel="prefetch" href="/GOFamily/assets/js/51.c30c1c33.js"><link rel="prefetch" href="/GOFamily/assets/js/52.b804bdad.js"><link rel="prefetch" href="/GOFamily/assets/js/53.8221a3a8.js"><link rel="prefetch" href="/GOFamily/assets/js/54.4d7d4483.js"><link rel="prefetch" href="/GOFamily/assets/js/55.fa5a6d59.js"><link rel="prefetch" href="/GOFamily/assets/js/56.f15db2e8.js"><link rel="prefetch" href="/GOFamily/assets/js/57.4d6ea1e1.js"><link rel="prefetch" href="/GOFamily/assets/js/58.04d964f4.js"><link rel="prefetch" href="/GOFamily/assets/js/59.eaf23c65.js"><link rel="prefetch" href="/GOFamily/assets/js/6.0f12c022.js"><link rel="prefetch" href="/GOFamily/assets/js/60.20afaad5.js"><link rel="prefetch" href="/GOFamily/assets/js/61.3131af66.js"><link rel="prefetch" href="/GOFamily/assets/js/62.8ba514e8.js"><link rel="prefetch" href="/GOFamily/assets/js/63.32ee10c3.js"><link rel="prefetch" href="/GOFamily/assets/js/64.46c9066e.js"><link rel="prefetch" href="/GOFamily/assets/js/65.578bd757.js"><link rel="prefetch" href="/GOFamily/assets/js/66.f8a4b483.js"><link rel="prefetch" href="/GOFamily/assets/js/67.bbeb0c9a.js"><link rel="prefetch" href="/GOFamily/assets/js/68.0b5844d7.js"><link rel="prefetch" href="/GOFamily/assets/js/7.0db9bcbe.js"><link rel="prefetch" href="/GOFamily/assets/js/70.a7df67cd.js"><link rel="prefetch" href="/GOFamily/assets/js/71.1080c71c.js"><link rel="prefetch" href="/GOFamily/assets/js/72.45a35ec4.js"><link rel="prefetch" href="/GOFamily/assets/js/73.e3a79c14.js"><link rel="prefetch" href="/GOFamily/assets/js/74.2084b84b.js"><link rel="prefetch" href="/GOFamily/assets/js/75.5e035ea4.js"><link rel="prefetch" href="/GOFamily/assets/js/8.d616309e.js"><link rel="prefetch" href="/GOFamily/assets/js/9.3fe8ee45.js">
    <link rel="stylesheet" href="/GOFamily/assets/css/0.styles.accc8640.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/GOFamily/" class="home-link router-link-active"><img src="https://avatars.githubusercontent.com/u/42873232" alt="GOFamily - go 后端程序员宝典" class="logo"> <span class="site-name can-hide">GOFamily - go 后端程序员宝典</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/GOFamily/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="project" class="dropdown-title"><span class="title">推荐项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="project" class="mobile-dropdown-title"><span class="title">推荐项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/shgopher/hui" target="_blank" rel="noopener noreferrer" class="nav-link external">
  hui 【web框架】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/shgopher/key" target="_blank" rel="noopener noreferrer" class="nav-link external">
  key  【服务授权系统】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/shgopher/ka" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ka  【秒杀服务】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/shgopher/go-key" target="_blank" rel="noopener noreferrer" class="nav-link external">
  go-short 【短链接服务】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Menu" class="dropdown-title"><span class="title">系列教程</span> <span class="arrow down"></span></button> <button type="button" aria-label="Menu" class="mobile-dropdown-title"><span class="title">系列教程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/GOFamily/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GOFamily 【go语言教程】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/408/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  408  【基础408知识教程】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/luban/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  luban  【系统设计教程】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/dingdang/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  dingdang  【工具教程】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/god/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  god  【给程序员写的书】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://shgopher.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  作者
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/shgopher/GOFamily" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/GOFamily/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="project" class="dropdown-title"><span class="title">推荐项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="project" class="mobile-dropdown-title"><span class="title">推荐项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/shgopher/hui" target="_blank" rel="noopener noreferrer" class="nav-link external">
  hui 【web框架】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/shgopher/key" target="_blank" rel="noopener noreferrer" class="nav-link external">
  key  【服务授权系统】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/shgopher/ka" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ka  【秒杀服务】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/shgopher/go-key" target="_blank" rel="noopener noreferrer" class="nav-link external">
  go-short 【短链接服务】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Menu" class="dropdown-title"><span class="title">系列教程</span> <span class="arrow down"></span></button> <button type="button" aria-label="Menu" class="mobile-dropdown-title"><span class="title">系列教程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/GOFamily/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GOFamily 【go语言教程】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/408/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  408  【基础408知识教程】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/luban/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  luban  【系统设计教程】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/dingdang/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  dingdang  【工具教程】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://shgopher.github.io/god/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  god  【给程序员写的书】
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://shgopher.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  作者
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/shgopher/GOFamily" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E/" class="sidebar-link">变量声明</a></li><li><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E5%B8%B8%E9%87%8F%E5%A3%B0%E6%98%8E/" class="sidebar-link">常量声明</a></li><li><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%9B%B6%E5%80%BC/" class="sidebar-link">零值</a></li><li><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E5%A4%8D%E5%90%88%E5%AD%97%E9%9D%A2%E9%87%8F/" class="sidebar-link">复合字面量</a></li><li><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E6%95%B0%E5%AD%97%E7%B1%BB%E5%9E%8B/" class="sidebar-link">数字类型</a></li><li><a href="/GOFamily/%E5%9F%BA%E7%A1%80/slice/" class="sidebar-link">slice</a></li><li><a href="/GOFamily/%E5%9F%BA%E7%A1%80/string/" class="sidebar-link">string</a></li><li><a href="/GOFamily/%E5%9F%BA%E7%A1%80/map/" class="sidebar-link">map</a></li><li><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E6%B1%82%E5%80%BC%E9%A1%BA%E5%BA%8F/" class="sidebar-link">求值顺序</a></li><li><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E4%BD%9C%E7%94%A8%E5%9F%9F/" class="sidebar-link">作用域</a></li><li><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E5%87%BD%E6%95%B0%E6%96%B9%E6%B3%95/" class="sidebar-link">函数方法</a></li><li><a href="/GOFamily/%E5%9F%BA%E7%A1%80/interface/" class="sidebar-link">interface</a></li><li><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E9%80%BB%E8%BE%91%E5%92%8C%E5%88%A4%E6%96%AD%E8%AF%AD%E5%8F%A5/" class="sidebar-link">逻辑和判断语句</a></li><li><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E5%85%B3%E9%94%AE%E5%AD%97/" class="sidebar-link">关键字</a></li><li><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E6%B3%9B%E5%9E%8B/" class="sidebar-link">泛型</a></li><li><a href="/GOFamily/%E5%9F%BA%E7%A1%80/%E5%85%B6%E4%BB%96%E5%86%85%E5%AE%B9/" class="sidebar-link">其他内容</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>并发</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/GOFamily/%E5%B9%B6%E5%8F%91/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/" aria-current="page" class="active sidebar-link">内存模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/GOFamily/%E5%B9%B6%E5%8F%91/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/#重排和可见性" class="sidebar-link">重排和可见性</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%B9%B6%E5%8F%91/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/#happens-before" class="sidebar-link">happens-before</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%B9%B6%E5%8F%91/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/#issues" class="sidebar-link">issues</a></li><li class="sidebar-sub-header"><a href="/GOFamily/%E5%B9%B6%E5%8F%91/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/#参考资料" class="sidebar-link">参考资料</a></li></ul></li><li><a href="/GOFamily/%E5%B9%B6%E5%8F%91/%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B/" class="sidebar-link">并发模型</a></li><li><a href="/GOFamily/%E5%B9%B6%E5%8F%91/%E5%B9%B6%E5%8F%91%E5%8E%9F%E8%AF%AD/" class="sidebar-link">并发原语</a></li><li><a href="/GOFamily/%E5%B9%B6%E5%8F%91/channel/" class="sidebar-link">channel</a></li><li><a href="/GOFamily/%E5%B9%B6%E5%8F%91/atomic/" class="sidebar-link">atomic</a></li><li><a href="/GOFamily/%E5%B9%B6%E5%8F%91/context/" class="sidebar-link">context</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>runtime</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/GOFamily/runtime/%E4%B8%89%E8%89%B2gc%E7%AE%97%E6%B3%95/" class="sidebar-link">三色gc算法</a></li><li><a href="/GOFamily/runtime/%E5%A0%86%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/" class="sidebar-link">堆内存分配</a></li><li><a href="/GOFamily/runtime/%E6%A0%88%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" class="sidebar-link">栈内存管理</a></li><li><a href="/GOFamily/runtime/%E7%B3%BB%E7%BB%9F%E7%9B%91%E6%8E%A7/" class="sidebar-link">系统监控</a></li><li><a href="/GOFamily/runtime/gmp/" class="sidebar-link">G:M:P</a></li><li><a href="/GOFamily/runtime/%E5%AE%9A%E6%97%B6%E5%99%A8/" class="sidebar-link">定时器</a></li><li><a href="/GOFamily/runtime/netpool/" class="sidebar-link">netpool</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>工程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/GOFamily/%E5%B7%A5%E7%A8%8B/%E5%8C%85%E5%8F%8A%E5%85%B6%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/" class="sidebar-link">包及其构建工具</a></li><li><a href="/GOFamily/%E5%B7%A5%E7%A8%8B/%E6%B5%8B%E8%AF%95/" class="sidebar-link">测试</a></li><li><a href="/GOFamily/%E5%B7%A5%E7%A8%8B/%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95/" class="sidebar-link">动态调试</a></li><li><a href="/GOFamily/%E5%B7%A5%E7%A8%8B/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/" class="sidebar-link">错误处理</a></li><li><a href="/GOFamily/%E5%B7%A5%E7%A8%8B/cgo/" class="sidebar-link">cgo</a></li><li><a href="/GOFamily/%E5%B7%A5%E7%A8%8B/%E4%BB%A3%E7%A0%81%E6%A3%80%E6%9F%A5/" class="sidebar-link">代码检查</a></li><li><a href="/GOFamily/%E5%B7%A5%E7%A8%8B/%E5%8F%8D%E5%B0%84/" class="sidebar-link">反射</a></li><li><a href="/GOFamily/%E5%B7%A5%E7%A8%8B/web/" class="sidebar-link">web</a></li><li><a href="/GOFamily/%E5%B7%A5%E7%A8%8B/wasm/" class="sidebar-link">wasm</a></li><li><a href="/GOFamily/%E5%B7%A5%E7%A8%8B/ioc/" class="sidebar-link">ioc</a></li><li><a href="/GOFamily/%E5%B7%A5%E7%A8%8B/%E5%91%BD%E4%BB%A4/" class="sidebar-link">命令</a></li><li><a href="/GOFamily/%E5%B7%A5%E7%A8%8B/%E4%BC%98%E7%A7%80%E7%AC%AC%E4%B8%89%E6%96%B9%E5%8C%85/" class="sidebar-link">优秀第三方包</a></li><li><a href="/GOFamily/%E5%B7%A5%E7%A8%8B/go%E6%A0%87%E5%87%86%E5%BA%93/" class="sidebar-link">go标准库</a></li><li><a href="/GOFamily/%E5%B7%A5%E7%A8%8B/%E9%A1%B9%E7%9B%AE%E7%BB%84%E7%BB%87%E5%BD%A2%E5%BC%8F/" class="sidebar-link">项目组织形式</a></li><li><a href="/GOFamily/%E5%B7%A5%E7%A8%8B/go%E5%91%BD%E5%90%8D%E6%83%AF%E4%BE%8B/" class="sidebar-link">go命名惯例</a></li><li><a href="/GOFamily/%E5%B7%A5%E7%A8%8B/go%E8%AF%AD%E8%A8%80%E8%A7%84%E8%8C%83/" class="sidebar-link">go语言规范</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="内存模型">内存模型</h1> <p>go官方介绍go内存模型的时候说：探究在什么条件下，goroutine 在读取一个变量的值的时，能够看到其它 goroutine 对这个变量进行的写的结果。</p> <p>我们为什么需要内存模型？由于cpu指令重排，以及多级的内存cache的存在，比如go语言存在的多级内存模型，不同的cpu架构，例如x86，arm 等等，而且编译器的优化也会对于指令进行重排，所以编程语言需要一个内存规范，即为：内存模型。</p> <p>介绍一些基本的操作：</p> <blockquote><p>除了基本的读和写之外都是同步操作，包括以下列举的，并且更多以这些基础操作衍生出的操作。</p></blockquote> <ul><li>读
<ul><li>基础的读
<ul><li>对超过机器word大小的值读，可以看作是拆成word大小的几个读的无序进行</li></ul></li> <li>原子包的读</li> <li>使用sync.mux 的读</li> <li>使用channel的收这种形式的读</li></ul></li> <li>写
<ul><li>基础的写
<ul><li>变量的初始化就是一个写操作</li> <li>对超过机器word大小的值写，可以看作是拆成word大小的几个写的无序进行</li></ul></li> <li>原子包的写</li> <li>sync.mux 的写</li> <li>使用channel的发</li></ul></li> <li>atomic的 compare and swap 操作，兼顾了写和读</li></ul> <p>我们讨论go内存模型的时候，主要聚焦下面四种细节的<strong>差异性</strong>：</p> <ul><li>操作的种类：
<ul><li>普通的读或者写</li> <li>同步操作，比如利用sync包进行同步，利用channel在不同的goroutine中间进行同步，利用atomic包进行同步等。</li></ul></li> <li>这个操作者在程序中的位置</li> <li>被操作者在内存位置，或者是被访问的变量的位置</li> <li>被操作者值的类型</li></ul> <p>内存模型主要用<strong>两个目的</strong>：</p> <ul><li><p>给程序员一个最根本的法则 --- 你只要遵循这个法则，那么在进行多 goroutine 数据访问的时候，做串行控制（使用同步操作）一定会成功。</p></li> <li><p>给编译器优化开发者一个法则，只要遵循这个法则，就能不出错的做出编译器级别的优化。</p></li></ul> <p>实际上，我们在内存模型中主要探究的<strong>具体表现</strong>有两方面：</p> <ul><li><strong>探究可见性</strong></li> <li><strong>happens- before</strong>：x 操作一定在 y 操作之前执行完毕，这里说的并不是时间，而是“执行完毕”这个结论，我们可以放心的在y中使用x的执行结果。主要突出的是这个完成性。</li></ul> <p>这里有<strong>三条定律</strong>：</p> <ul><li><p>在一个goroutine中，程序执行的顺序一定是符合代码写的顺序的。但是不同的goroutine中这个定理失效。</p></li> <li><p>在<strong>同步操作</strong>的时候，从a goroutine看到b goroutine的执行顺序，必须符合同步操作的顺序，这里举个例子，举例：b的同步操作是什么顺序，那么a读取的就是什么顺序。比如 b中有三个Channel，他们执行的顺序是 先 a 发 b 收，b 发，c 收，那么在a中读取的顺序跟这个同步的操作顺序是一致的，<strong>如果不是同步操作就可能不一致。</strong></p></li> <li><p>对于非同步操作的普通读和写，如果b操作了a，那么必须成立</p> <ul><li>b发生在a之前</li></ul></li></ul> <p>我们可以使用 <code>go build -race</code> 来发现数据竞争。</p> <p>接下来我们对于内存模型的具体表现进行更具体的介绍。</p> <h2 id="重排和可见性">重排和可见性</h2> <p>由于指令的重排，代码<strong>不一定</strong>会按照你写的顺序执行。</p> <p>这里给出一个案例：有两个 goroutine 分别是g1，和g2，g1读某个变量的数据，g2写这个变量的数据，当g1读取到g2写的新数据之后，你也不一定能读取到在 goroutine g2 中排列在这个写数据操作之前的操作：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	a    <span class="token operator">=</span> <span class="token number">1</span>
	b    <span class="token operator">=</span> <span class="token number">2</span>
	done <span class="token builtin">bool</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		a <span class="token operator">=</span> <span class="token number">3</span>
		b <span class="token operator">=</span> <span class="token number">4</span>
		done <span class="token operator">=</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token operator">!</span>done <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment">// 可能观察到的就是输出的 4 3，但是无法保证必须是4 3 ，能观察到 != 保证</span>
<span class="token punctuation">}</span>

</code></pre></div><p>下面这种情况，a goroutine 无法观察到 b goroutine 是否完成了写操作，有可能造成 a goroutine 一直被卡的现象：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Result <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	data <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	r <span class="token operator">*</span>Result
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	d <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Result<span class="token punctuation">)</span>
	d<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token string">&quot;hi there&quot;</span> <span class="token comment">// 这里无法确认一定会运行</span>
	r <span class="token operator">=</span> d <span class="token comment">// 这里无法确认观察到</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">go</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> r <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><blockquote><p>there is no guarantee that the write to done will ever be observed by main, <strong>since there are no synchronization events between the two threads</strong>. The loop in main is not guaranteed to finish.&quot;</p></blockquote> <p>这一句是 go blog中对于这代代码的描述，重点是说，这俩线程中，没有存在同步原语，所以无法做到从main goroutine 去观测到 r 的状态，也就是说，在goroutine中只要存在了同步原语，那么就可以把两个goroutine当作正常的语句来看。</p> <p>这里有两点无法确认，第一：主 goroutine 无法<strong>确认</strong> r 的状态，这里指的就是 <strong>可观测性</strong>，因为这里是非同步操作，所以主 goroutine的读无法观测到 <code>go set（）</code> 这里 <code>r = d</code> 这里的写，注意是无法完全确认，通常来说这段代码是可以运行的，我说的是通常，第二 无法保证 <code>d.data</code> 一定会运行，所以有可能输出的是空字符串，这里说的就是因为编译优化导致的指令重排。</p> <h2 id="happens-before">happens-before</h2> <p>go 不直接提供cpu 屏障，来保证编译器或者cpu保证顺序性，而是使用不同架构的内存屏障指令来实现统一的并发原语。</p> <h3 id="单个-goroutine">单个 goroutine</h3> <p>上文说到，<strong>在一个goroutine中，happens- before 其实就等于代码书写的顺序，这一点是严格成立的</strong>。</p> <h3 id="init函数">init函数</h3> <p>go语言的初始化是在单一的goroutine中执行的，也就是main goroutine 。</p> <p><strong>p 包导入了q包，那么q的init函数一定 happens  before p的任何初始化代码</strong>。</p> <p>这里有点像树，导入的过程，以及初始化的过程，会形成一个多叉树，从最底层的树开始进行初始化，逐步的忘上层走，先进后出，栈一样的感觉，并且相同的包只会导入一次，进而也只会初始化一次，比如q包被第三层导入了，在第五层也导入了，那么这个包在从底层往上走的过程中，只会在第五层先全局变量后init函数的初始化一次。这导入的包全部初始化一遍之后，才开始进行main包的mian函数，然后进而去运行接下来的逻辑。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span><span class="token punctuation">(</span>
  a <span class="token operator">=</span> c <span class="token operator">+</span> b

  b <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  
  c <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  d <span class="token operator">=</span> <span class="token number">3</span> 
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span><span class="token punctuation">{</span>
  d <span class="token operator">++</span> 
  <span class="token keyword">return</span> d 
<span class="token punctuation">}</span>
</code></pre></div><p>初始化的顺序是这样的，首先初始化a，因为a = c + b ，那么系统开始初始化 c 和 b ，c 和b 等于一个函数f，那么就开始初始化这个函数，函数里面是d 那么开始初始化d，所以 b = 3+1  c = 3+1+1 a = 9 ，这个时候d已经++ 两次了，所以最终的初始化以后 a = 9 b = 4 c = 5 d = 5</p> <p>包级别的变量按照代码顺序初始化，同一个包的众多文件会按照文件名的排列顺序进行初始化。</p> <h3 id="goroutine">goroutine</h3> <p>启动goroutine的go语言执行，一定happens - before 此goroutine内的代码执行。退出可就没有任何happens- before 的理论了，所以退出我们通常要部署同步语句。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> a <span class="token builtin">string</span>
<span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  a <span class="token operator">=</span> <span class="token string">&quot;hi&quot;</span>
  <span class="token keyword">go</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从单个goroutine的happens- before的关系来看， a = “hi” 一定 happens- before go f（） ，从新goroutine的开辟来说，go f（） 一定happens- before fmt.Println 所以这个代码中，hi一定能被输出。</p> <h3 id="channel">channel</h3> <p>go语言有一句经典名言，不要使用共享内存来通信（sync.Mutex）而应该采用通信的方式来共享内存，这个后者说的就是channel，channel是同步操作的首选。</p> <ul><li>往channel中发数据，happens - before 从这个channel 接收数据<strong>完成</strong>。注意这里说的是接收完成，<strong>没说</strong>发数据happens- before 这个channel 接受数据开始的时候。</li></ul> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> a <span class="token builtin">string</span> 

<span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//这里之所以a = hi 发生在 c &lt;-0 之前，就是因为这个goroutine和main goroutine 存在同步原语，</span>
  <span class="token comment">//只要存在，那么代码就会按照程序员写的顺序执行，并不会进行重排。</span>
  a <span class="token operator">=</span> <span class="token string">&quot;hi&quot;</span> 
  c <span class="token operator">&lt;-</span><span class="token number">0</span>  <span class="token comment">// 这里因为有了同步操作，所以 a = “hi” 在main goroutine看 也是 a= “hi” happens- before c &lt;- 0</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">go</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token operator">&lt;-</span>c <span class="token comment">// 这里只要收到数据了，那么 c &lt;- 0 肯定已经运行了，并且发送完毕了。</span>
  <span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>close 一个channel 一定 happens- before 从关闭的channel 中读取一个零值。我们都知道可以从一个closed 的一个channel中读取零值是可以的，这里说明的是读零值这个过程一定在关闭这个操作之后。</p></li> <li><p>一个 unbuffered 的channle，读的准备好一定 happens-before 发准备好，意思是说，只有收数据准备好了，才能发，否则就会一直卡在发那个地方。</p></li> <li><p>一个容量大于0为m的channel，第n个接收，一定happens- before 第n+m的发送，意思是说，如果容量满了，必须先拿出来一个才能往里面再塞进去一个。比如：n=1 m=2 ，第一个接收一定happens- before 第三个发送，因为容量一共是2，要想往里面塞进去第三个，<strong>必须拿出来一个并且拿出来这个操作完毕了</strong>，才能发送第三个。</p></li></ul> <h3 id="mutex-rwmutex">Mutex/RWMutex</h3> <ul><li>第n次的unlock 一定happends- before 第n+1 次 lock方法的返回
意思是说，只有先解锁才能再次加锁。</li> <li>读写锁虽然有两把锁，但是不能同时使用，必须等待一个锁解锁后，另一个锁才能上锁，比如读锁解锁后才能再次上读锁，或者才能上写锁。</li></ul> <p>互斥锁可以由 a goroutine 上锁， b goroutine 解锁</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> mu sync<span class="token punctuation">.</span>Mutex
<span class="token keyword">var</span> s <span class="token builtin">string</span>

<span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  s <span class="token operator">=</span> <span class="token string">&quot;hi&quot;</span>
  mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 这里拥有了一个同步原语，所以 s = hi 一定发生在 mu.unlock() 之前。（相当于在一段锁的内部）</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">go</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  mu<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 这里的unlock 一定发生在  另一个goroutine 中f 的 mu.Unlock() 之后。</span>
  <span class="token function">print</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="waitgroup">WaitGroup</h3> <ul><li>wait 方法等到计数值归零才能返回（运行完毕）</li></ul> <h3 id="once">Once</h3> <ul><li>对于once.Do(f) f 一定会在do 方法返回之前执行。</li></ul> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> s <span class="token builtin">string</span>
<span class="token keyword">var</span> once sync<span class="token punctuation">.</span>Once

<span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
  s <span class="token operator">=</span> <span class="token string">&quot;hi&quot;</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  once<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
  <span class="token function">print</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token comment">// 这里 f 的执行完毕 一定在 Do()返回之前,所以一定能输出 s = hi</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="atomic">atomic</h3> <p>按照 atomic load / store 顺序 来保证 happens - before 不过go官方并没有严格定义，直到目前为止并没有严格定义。</p> <div class="language-go extra-class"><pre class="language-go"><code>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> a<span class="token punctuation">,</span> b <span class="token builtin">int32</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>

  <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    atomic<span class="token punctuation">.</span><span class="token function">StoreInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    atomic<span class="token punctuation">.</span><span class="token function">StoreInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">for</span> atomic<span class="token punctuation">.</span><span class="token function">LoadInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">{</span>
    runtime<span class="token punctuation">.</span><span class="token function">Gosched</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">LoadInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="issues">issues</h2> <p><code>使用channel实现一个互斥锁</code></p> <p>我们利用 channel 发送数据 happens- before 收到数据完毕 这个特性来实现互斥锁。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> Locker <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	ch  <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 初始状态是已经有一个</span>
<span class="token keyword">func</span> <span class="token function">NewLocker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>Locker<span class="token punctuation">{</span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
	ch <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Locker<span class="token punctuation">{</span>
		ch<span class="token punctuation">:</span> ch<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// lock 从缓存是1编程0，从chan中取出来数据</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>Locker<span class="token punctuation">)</span> <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	<span class="token operator">&lt;-</span> l<span class="token punctuation">.</span>ch
<span class="token punctuation">}</span>
<span class="token comment">// unlock 将缓存从0变成1，向ch中放入数据。</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>Locker<span class="token punctuation">)</span> <span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	l<span class="token punctuation">.</span>ch <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>一个小小的经验：channel 拥有buffer比没有buffer常用很多。</p> <p>完结。</p> <h2 id="参考资料">参考资料</h2> <ul><li>https://go.dev/ref/mem</li> <li>https://time.geekbang.org/column/article/307469</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/shgopher/GOFamily/edit/release/并发/内存模型/README.md" target="_blank" rel="noopener noreferrer">在GitHub中编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">12/2/2022, 10:18:44 AM</span></div></footer> <!----> </main></div><div class="global-ui"><div></div><!----></div></div>
    <script src="/GOFamily/assets/js/app.a103b542.js" defer></script><script src="/GOFamily/assets/js/2.ed67c6f0.js" defer></script><script src="/GOFamily/assets/js/69.633fc06b.js" defer></script>
  </body>
</html>
